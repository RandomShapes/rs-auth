!function(){var t=angular.module("rs-auth",[]),e={authUrl:"",loginEndPoint:"/auth",registerEndPoint:"/register",validateEndPoint:"/auth",logoutEndPoint:"/logout",user:"currentUser"},n={all:"*"};t.constant("AUTH_EVENTS",{loginSuccess:"$authLoginSuccess",loginFailed:"$authLoginFailed",logoutSuccess:"$authLogoutSuccess",sessionTimeout:"$authSessionTimeout",notAuthenticated:"$authNotAuthenticated",notAuthorized:"$authNotAuthorized"}),t.factory("Local",["$http","$window","$rootScope",function(t,n,o){var r={};return r.login=function(r){return t({url:e.authUrl+e.loginEndPoint,method:"POST",data:r}).then(function(t){return r.remember&&n.localStorage.setItem("authToken",t.data.token),n.sessionStorage.setItem("authToken",t.data.token),o[e.user]=t.data.user,t})},r.logout=function(){return t({url:e.authUrl+e.logoutEndPoint,method:"GET",headers:{"X-Auth-Token":n.sessionStorage.getItem("authToken")}}).then(function(){n.localStorage.clear(),n.sessionStorage.clear(),o[e.user]=null})},r.register=function(r){return t({url:e.authUrl+e.registerEndPoint,method:"POST",data:r}).then(function(t){return n.sessionStorage.setItem("authToken",t.data.token),o[e.user]=t.data.user,t})},r.validateToken=function(r){return t({url:e.authUrl+e.validateEndPoint,method:"GET",headers:{"X-Auth-Token":r}}).then(function(t){return n.sessionStorage.setItem("authToken",r),o[e.user]=t.data,t})},r.isAuthenticated=function(){return n.sessionStorage.getItem("authToken")},r.isAuthorized=function(t){return angular.isArray(t)||(t=[t]),this.isAuthenticated()&&-1!==t.indexOf(o[e.user].role)},r.isRemembered=function(){return n.localStorage.getItem("authToken")},r.getToken=function(){return n.sessionStorage.getItem("authToken")},r}]),t.provider("$rsAuth",function(){this.config=e,this.userRoles=n,this.setUserRoles=function(t){angular.extend(n,t)},this.$get=["Local",function(t){return{login:function(e){return t.login(e)},logout:function(){return t.logout()},register:function(e){return t.register(e)},validateToken:function(e){return t.validateToken(e)},isAuthenticated:function(){return t.isAuthenticated()},isAuthorized:function(e){return t.isAuthenticated(e)},isRemembered:function(){return t.isRemembered()},getToken:function(){return t.getToken()},userRoles:n}}]}),t.run(["AUTH_EVENTS","$rootScope","$rsAuth",function(t,n,o){n[e.user]={};var r;o.isAuthenticated()?(r=o.isAuthenticated(),o.validateToken(r).then(function(){n.$broadcast(t.loginSuccess)})):o.isRemembered()&&(r=o.isRemembered(),o.validateToken(r).then(function(){n.$broadcast(t.loginSuccess)}));var u=function(t){for(var e in t)if("*"===t[e])return!0;return!1};n.$on("$stateChangeStart",function(e,r){var i={all:"*"};r.data&&r.data.authorizedRoles&&(i=r.data.authorizedRoles),u(i)||o.isAuthorized(i)||(e.preventDefault(),n.$broadcast(o.isAuthenticated()?t.notAuthorized:t.notAuthenticated))})}])}();