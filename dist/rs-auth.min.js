!function(t){var e=t.module("rs-auth",[]),n={authUrl:"",loginEndPoint:"/auth",registerEndPoint:"/register",validateEndPoint:"/auth",logoutEndPoint:"/logout",user:"currentUser"},o={all:"*"};e.constant("AUTH_EVENTS",{loginSuccess:"$authLoginSuccess",loginFailed:"$authLoginFailed",logoutSuccess:"$authLogoutSuccess",sessionTimeout:"$authSessionTimeout",notAuthenticated:"$authNotAuthenticated",notAuthorized:"$authNotAuthorized"}),e.factory("Local",["$http","$window","$rootScope",function(e,o,r){var u={};return u.login=function(t){return e({url:n.authUrl+n.loginEndPoint,method:"POST",data:t}).then(function(e){return t.remember&&o.localStorage.setItem("authToken",e.data.token),o.sessionStorage.setItem("authToken",e.data.token),r[n.user]=e.data.user,e})},u.logout=function(){return e({url:n.authUrl+n.logoutEndPoint,method:"GET",headers:{"X-Auth-Token":o.sessionStorage.getItem("authToken")}}).then(function(){o.localStorage.clear(),o.sessionStorage.clear(),r[n.user]=null})},u.register=function(t){return e({url:n.authUrl+n.registerEndPoint,method:"POST",data:t}).then(function(t){return o.sessionStorage.setItem("authToken",t.data.token),r[n.user]=t.data.user,t})},u.validateToken=function(t){return e({url:n.authUrl+n.validateEndPoint,method:"GET",headers:{"X-Auth-Token":t}}).then(function(e){return o.sessionStorage.setItem("authToken",t),r[n.user]=e.data,e})},u.isAuthenticated=function(){return o.sessionStorage.getItem("authToken")},u.isAuthorized=function(e){return t.isArray(e)||(e=[e]),this.isAuthenticated()&&-1!==e.indexOf(r[n.user].role)},u.isRemembered=function(){return o.localStorage.getItem("authToken")},u.getToken=function(){return o.sessionStorage.getItem("authToken")},u}]),e.provider("$rsAuth",function(){this.config=n,this.userRoles=o,this.setUserRoles=function(e){t.extend(o,e)},this.$get=["Local",function(t){return{login:function(e){return t.login(e)},logout:function(){return t.logout()},register:function(e){return t.register(e)},validateToken:function(e){return t.validateToken(e)},isAuthenticated:function(){return t.isAuthenticated()},isAuthorized:function(e){return t.isAuthenticated(e)},isRemembered:function(){return t.isRemembered()},getToken:function(){return t.getToken()},userRoles:o}}]}),e.run(["AUTH_EVENTS","$rootScope","$rsAuth",function(t,e,n){var o;n.isAuthenticated()?(o=n.isAuthenticated(),n.validateToken(o).then(function(){e.$broadcast(t.loginSuccess)})):n.isRemembered()&&(o=n.isRemembered(),n.validateToken(o).then(function(){e.$broadcast(t.loginSuccess)}));var r=function(t){for(prop in t)if("*"===t[prop])return!0;return!1};e.$on("$stateChangeStart",function(o,u){var i={all:"*"};u.data&&u.data.authorizedRoles&&(i=u.data.authorizedRoles),r(i)||n.isAuthorized(i)||(o.preventDefault(),e.$broadcast(n.isAuthenticated()?t.notAuthorized:t.notAuthenticated))})}])}(window.angular);